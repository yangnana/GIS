var OPENLAYER_MAP = {};

OPENLAYER_MAP.routePoints = "12975693.279691,4834989.687621892;12975693.727564212,4834989.911558499;12975694.25008296,4834990.172817873;12975693.839532515,4834990.881950459;12975693.42898207,4834991.441791975;12975693.018431624,4834992.038956258;12975692.645203948,4834992.524152239;12975692.234653503,4834993.046670987;12975691.936071362,4834993.4945442;12975691.63748922,4834993.905094645;12975691.189616008,4834994.5022589285;12975690.853711098,4834994.950132141;12975690.51780619,4834995.472650888;12975690.107255744,4834996.032492405;12975689.734028066,4834996.629656688;12975689.360800387,4834997.040207135;12975689.024895478,4834997.4694189625;12975688.726313338,4834997.861308024;12975688.446392579,4834998.215874317;12975688.129149053,4834998.551779226;12975687.86788968,4834998.887684136;12975687.606630305,4834999.223589046;12975687.326709548,4834999.596816723;12975687.12143433,4834999.951383015;12975686.878836337,4835000.324610692;12975686.561592814,4835000.772483905;12975686.244349288,4835001.164372967;12975685.945767146,4835001.593584795;12975685.665846387,4835001.948151088;12975685.423248397,4835002.284055998;12975685.124666255,4835002.73192921;12975684.844745498,4835003.21712519;12975684.56482474,4835003.664998404;12975684.266242597,4835004.112871616;12975683.967660457,4835004.448776525;12975683.680606313,4835004.854932353;12975683.475331092,4835005.246821415;12975683.195410334,4835005.6387104755;12975682.896828191,4835006.011938153;12975682.616907435,4835006.347843062;12975682.336986676,4835006.814377658;12975682.131711453,4835007.20626672;12975681.87045208,4835007.560833013;12975681.683838245,4835008.102013143;12975682.09438869,4835008.661854659;12975682.766198508,4835009.109727872;12975683.139426185,4835009.482955549;12975683.661944933,4835009.930828761;12975684.072495379,4835010.416024742;12975684.408400288,4835011.013189025;12975684.893596267,4835011.42373947;12975685.528083319,4835011.834289915;12975686.087924834,4835012.207517592;12975686.64776635,4835012.4687769655;12975687.431544473,4835012.692713573;12975687.991385989,4835012.879327411;12975688.513904737,4835012.879327411;12975689.185714556,4835012.916650179;12975689.969492678,4835012.953972946;12975690.60397973,4835012.991295714;12975691.313112315,4835013.103264017;12975691.947599366,4835012.916650179;12975692.171535973,4835012.431454198;12975692.320827045,4835011.90893545;12975692.69405472,4835011.42373947;12975692.992636863,4835011.08783456;12975693.21657347,4835010.677284116;12975693.440510076,4835010.1920881355;12975693.627123915,4835009.78153769;12975693.776414985,4835009.072405104;12975693.776414985,4835008.512563588;12975693.515155612,4835008.027367608;12975693.02995963,4835007.691462698;12975692.582086418,4835007.430203324;12975692.096890438,4835006.982330112;12975691.499726154,4835006.534456898;12975691.089175709,4835006.198551989;12975690.56665696,4835005.750678777;12975690.118783748,4835005.489419403;12975689.857524374,4835005.004223422;12975689.93216991,4835004.519027442;12975690.118783748,4835003.959185926;12975690.417365888,4835003.548635482;12975690.753270797,4835003.026116733;12975691.089175709,4835002.690211824;12975691.462403385,4835002.018402006;12975691.723662758,4835001.60785156;12975691.984922133,4835001.159978348;12975691.984922133,4835000.7494279025;12975691.928937985,4835000.403008259;12975691.910276601,4835000.06710335;12975691.910276601,4834999.712537057;12975692.022244904,4834999.395293531;12975692.078229055,4834999.022065854;12975692.15287459,4834998.779467864;12975692.264842898,4834998.182303582;12975692.264842898,4834997.697107602;12975692.264842898,4834997.249234389;12975692.488779506,4834996.726715641;12975692.787361646,4834996.166874126;12975693.150375847,4834995.698573955;12975693.635571826,4834995.399991814;12975693.859508432,4834994.877473066;12975694.195413342,4834994.31763155";

OPENLAYER_MAP.markerInfos = {"resultMsg":"success","resultData":{"navCoodInfos":[{"X":116.562652,"Y":39.786677,"Z":1,"Azimuth":"3.141593","Kind":6,"Value":"ON928531303766036480_ENTE028"},{"X":116.562613,"Y":39.78672,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562573,"Y":39.786764,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562532,"Y":39.786808,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562497,"Y":39.786846,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562456,"Y":39.78689,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.56242,"Y":39.786929,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.56238,"Y":39.786973,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562339,"Y":39.787017,"Z":1,"Azimuth":"2.034444","Kind":0,"Value":"0"},{"X":116.562348,"Y":39.78703,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562328,"Y":39.787052,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562293,"Y":39.787091,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562252,"Y":39.787135,"Z":1,"Azimuth":"3.141593","Kind":0,"Value":"0"},{"X":116.562232,"Y":39.787157,"Z":1,"Azimuth":"1.892547","Kind":0,"Value":"0"},{"X":116.562264,"Y":39.787191,"Z":1,"Azimuth":"2.930499","Kind":0,"Value":"0"},{"X":116.562254,"Y":39.787209,"Z":1,"Azimuth":"-0.321751","Kind":5,"Value":"ON928531303766036480_A927733138762371072"},{"X":116.562259,"Y":39.787197,"Z":1,"Azimuth":"-1.107149","Kind":0,"Value":"0"},{"X":116.562232,"Y":39.787157,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562272,"Y":39.787113,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562313,"Y":39.787069,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562348,"Y":39.78703,"Z":1,"Azimuth":"-0.785398","Kind":0,"Value":"0"},{"X":116.562346,"Y":39.787021,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562382,"Y":39.786982,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562428,"Y":39.786933,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562463,"Y":39.786894,"Z":1,"Azimuth":"-0.141897","Kind":0,"Value":"0"},{"X":116.562491,"Y":39.786852,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562532,"Y":39.786808,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562573,"Y":39.786764,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562613,"Y":39.78672,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562648,"Y":39.786681,"Z":1,"Azimuth":"0.000000","Kind":0,"Value":"0"},{"X":116.562652,"Y":39.786677,"Z":1,"Azimuth":"0.000000","Kind":7,"Value":"ON928531303766036480_ENTE028"}]},"resultCode":200};

OPENLAYER_MAP.popContainer = document.getElementById('popup');//主体  
OPENLAYER_MAP.popContent = document.getElementById('popup-content');//正文  
OPENLAYER_MAP.popCloser = document.getElementById('popup-closer');//关闭框  

OPENLAYER_MAP.robotRoutePoint = [];

OPENLAYER_MAP.robotRoutePointIndex = 0;

OPENLAYER_MAP.robotItem;

OPENLAYER_MAP.featureContainer = new Array();

OPENLAYER_MAP.popUpItem = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
    element: OPENLAYER_MAP.popContainer,
    autoPan: true,
    autoPanAnimation: {
      duration: 250
    }
  }));

OPENLAYER_MAP.mapContainer = "#mapContainer";

OPENLAYER_MAP.mousePositionControl;

OPENLAYER_MAP.map;

OPENLAYER_MAP.qqMapLayer;

OPENLAYER_MAP.anchorLayer;

OPENLAYER_MAP.googleMapLayer;

OPENLAYER_MAP.robotStyle = new ol.style.Style({
    image: new ol.style.Icon({
        src: 'images/robot_red.png'
    })
});

OPENLAYER_MAP.broadcastStyle = new ol.style.Style({
    image: new ol.style.Icon({
        src: 'images/mapMarkers/broadcast.png',
        scale:0.75
    })
});

OPENLAYER_MAP.coffeeStyle = new ol.style.Style({
    image: new ol.style.Icon({
        src: 'images/mapMarkers/coffee.png',
        scale:0.9
    })
});

OPENLAYER_MAP.elevatorStyle = new ol.style.Style({
    image: new ol.style.Icon({
        src: 'images/mapMarkers/elevator.png',
        scale:0.75
    })
});

OPENLAYER_MAP.keypointStyle = new ol.style.Style({
    image: new ol.style.Icon({
        src: 'images/mapMarkers/keypoint.png',
        scale:0.75
    })
});

OPENLAYER_MAP.pickupStyle = new ol.style.Style({
    image: new ol.style.Icon({
        src: 'images/mapMarkers/pickup.png',
        scale:0.9
    })
});

//创建标签的样式
OPENLAYER_MAP.createLabelStyle = function (feature) {
    //返回一个样式
    return new ol.style.Style({
        //把点的样式换成ICON图标
        image: new ol.style.Icon({
            //控制标注图片和文字之间的距离
            anchor: [0.5, 20],
            //标注样式的起点位置
            anchorOrigin: 'top-right',
            //X方向单位：分数
            anchorXUnits: 'fraction',
            //Y方向单位：像素
            anchorYUnits: 'pixels',
            //偏移起点位置的方向
            offsetOrigin: 'top-right',
            //透明度
            opacity: 0.75,
            scale:0.8,
            //图片路径
            src: 'images/mapMarkers/coffee.png'
        }),
        //文本样式
        text: new ol.style.Text({
            //对齐方式
            textAlign: 'center',
            //文本基线
            textBaseline: 'middle',
            //字体样式
            font: 'normal 13px 微软雅黑',
            //文本内容
            text: feature.get('name'),
            offsetY:-23,
            //填充样式
            fill: new ol.style.Fill({
                color: '#8F8F8F'
            })/*,
            //笔触
            stroke: new ol.style.Stroke({
                color: '#ffffff',
                width: 1
            })*/
        })
    });
};

OPENLAYER_MAP.initMapEvents = function(){
  OPENLAYER_MAP.map.on('singleclick', function(event){
         debugger;
        // 通过getEventCoordinate方法获取地理位置，再转换为wgs84坐标，并弹出对话框显示
        var pos = event.coordinate;
        var coord = ol.proj.transform(event.coordinate, 'EPSG:3857', 'EPSG:4326');
        //alert(coord);

        //创建marker
        var anchor = new ol.Feature({
          geometry: new ol.geom.Point(pos)
        });

         anchor.setStyle(OPENLAYER_MAP.robotStyle);

        //加入图层中
        OPENLAYER_MAP.anchorLayer.getSource().addFeature(anchor);
    })
};

OPENLAYER_MAP.initAnchorLayer = function(){
  OPENLAYER_MAP.anchorLayer = new ol.layer.Vector({
    source: new ol.source.Vector(),
    name:'anchorLayer'
  })
};

OPENLAYER_MAP.initMap = function(){

  OPENLAYER_MAP.mousePositionControl = new ol.control.MousePosition({
        coordinateFormat: ol.coordinate.createStringXY(5),
        projection: 'EPSG:4326',
        className: 'custom-mouse-position',
        target: document.getElementById('txt-coords'),
        undefinedHTML: '&nbsp;'
      });


	var layers = [
        OPENLAYER_MAP.googleMapLayer,
        OPENLAYER_MAP.qqMapLayer,
        OPENLAYER_MAP.anchorLayer
      	];

    OPENLAYER_MAP.map = new ol.Map({
      controls: ol.control.defaults({
        attribution: false
      }).extend([
        new ol.control.ScaleLine({
          units: 'degrees'
        }),
        OPENLAYER_MAP.mousePositionControl
      ]),
      layers: layers,
      overlays: [OPENLAYER_MAP.popUpItem],
      target: 'mapContainer',
      view: new ol.View({
        projection: 'EPSG:3857',
        center: [12975693.279691,4834989.687621892],//ol.proj.fromLonLat([116.5024197900, 39.7963951900]),
        zoom: 17,
        minZoom:4,
        maxZoom:24
      })
    });

    OPENLAYER_MAP.googleMapLayer.setVisible(false);
};

OPENLAYER_MAP.initQQLayer = function(){

    var qqMap_source = new ol.source.XYZ({
        tileUrlFunction: function(tileCoord){
            if(!tileCoord)return "";

            var z = tileCoord[0];
            var x = tileCoord[1];
            var y = -tileCoord[2] - 1;
            y = parseInt(Math.pow(2, z)) - 1 - y;
            return "http://rt" + (x % 4) + ".map.gtimg.com/realtimerender?z=" + z + "&x=" + x + "&y=" + y + "&styleid=0&type=vector&version=233";
        }
    });

    OPENLAYER_MAP.qqMapLayer = new ol.layer.Tile({
        name:'qqLayer',
        source: qqMap_source
    });
};

OPENLAYER_MAP.initGoogleLayer = function(){
    var googleMap_source = new ol.source.XYZ({url: 'http://maps.google.com/maps/vt?pb=!1m5!1m4!1i{z}!2i{x}!3i{y}!4i256!2m3!1e0!2sm!3i375060738!3m9!2spl!3sUS!5e18!12m1!1e47!12m3!1e37!2m1!1ssmartmaps!4e0'});

    OPENLAYER_MAP.googleMapLayer = new ol.layer.Tile({
        source: googleMap_source,
        name:'google'
    });
};

OPENLAYER_MAP.exchangeMapType = function(){

  if(OPENLAYER_MAP.googleMapLayer.getVisible())
    {
      OPENLAYER_MAP.googleMapLayer.setVisible(false);
      OPENLAYER_MAP.qqMapLayer.setVisible(true);

      $('#exchangeMapType').text('Google');
    }
  else
  {
      OPENLAYER_MAP.googleMapLayer.setVisible(true);
      OPENLAYER_MAP.qqMapLayer.setVisible(false);

      $('#exchangeMapType').text('Tencent');
  }
};

OPENLAYER_MAP.buildRobotRoutePoint = function(){
   OPENLAYER_MAP.robotRoutePoint = OPENLAYER_MAP.routePoints.split(';');
};

OPENLAYER_MAP.updateRobotPosition = function(){
  if((OPENLAYER_MAP.robotRoutePointIndex + 1) > OPENLAYER_MAP.robotRoutePoint.length)
        OPENLAYER_MAP.robotRoutePointIndex = 0;

    
    //debugger;
    var point = OPENLAYER_MAP.robotRoutePoint[++OPENLAYER_MAP.robotRoutePointIndex];

    var posArray = point.split(',');

    if(OPENLAYER_MAP.robotItem == null)
    {
        //创建marker
        OPENLAYER_MAP.robotItem = new ol.Feature({
            geometry: new ol.geom.Point(posArray)
        });

        OPENLAYER_MAP.robotStyle.setZIndex(999);
        OPENLAYER_MAP.robotItem.setStyle(OPENLAYER_MAP.robotStyle);

        //加入图层中
        OPENLAYER_MAP.anchorLayer.getSource().addFeature(OPENLAYER_MAP.robotItem);
    }
    else
    {
        //更新位置
        OPENLAYER_MAP.robotItem.setGeometry(new ol.geom.Point(posArray));
    }
};

OPENLAYER_MAP.initMarkers = function(){

    var navRouteCoords = OPENLAYER_MAP.markerInfos.resultData.navCoodInfos;

    //架路径，绘制关键节点
    if(navRouteCoords == null || navRouteCoords.length == 0)return;

    var routeLinePoints = new Array();
    // var navigationNode = null;
    var coordGcj02 = new Array();
    var coordPoint = new Array();
    $.each(navRouteCoords,function(index,value){

        coordGcj02[0] = value.X;coordGcj02[1] = value.Y;

        coordPoint = ol.proj.transform(coordGcj02,"EPSG:4326","EPSG:3857");

        //创建marker
        var marker = new ol.Feature({
            geometry: new ol.geom.Point(coordPoint),
            name: "hello"
        });

        switch(value.Kind)
        {
            case 0:
                marker.setStyle(OPENLAYER_MAP.keypointStyle);
                OPENLAYER_MAP.anchorLayer.getSource().addFeature(marker);
                break;
            case 1:
                marker.setStyle(OPENLAYER_MAP.broadcastStyle);
                OPENLAYER_MAP.anchorLayer.getSource().addFeature(marker);
                break;
            case 2:
                marker.setStyle(OPENLAYER_MAP.elevatorStyle);
                OPENLAYER_MAP.anchorLayer.getSource().addFeature(marker);
                break;
            case 4:
            case 5:
                marker.setStyle(OPENLAYER_MAP.pickupStyle);
                OPENLAYER_MAP.anchorLayer.getSource().addFeature(marker);
                break;
            case 6:
            case 7:
                marker.setStyle(OPENLAYER_MAP.createLabelStyle(marker));
                OPENLAYER_MAP.anchorLayer.getSource().addFeature(marker);
                break;
        }

        routeLinePoints.push(coordPoint);
    });

    OPENLAYER_MAP.initPolyline(routeLinePoints);
};

OPENLAYER_MAP.initPolyline = function(linePoints){
    var lineFeature = new ol.Feature({
        geometry: new ol.geom.LineString(linePoints)
    });

    //加入图层中
    OPENLAYER_MAP.anchorLayer.getSource().addFeature(lineFeature);
};

OPENLAYER_MAP.initPopUpEvents = function()
{
  OPENLAYER_MAP.popCloser.onclick = function() {
        OPENLAYER_MAP.popUpItem.setPosition(undefined);
        OPENLAYER_MAP.popCloser.blur();
        return false;
      };

  //鼠标移动事件：触到要素变鼠标指针  
  OPENLAYER_MAP.map.on('pointermove',function(e){  
      var pixel = OPENLAYER_MAP.map.getEventPixel(e.originalEvent); //获取地图上的坐标  
      var hit = OPENLAYER_MAP.map.hasFeatureAtPixel(pixel);//获取地图坐标上的要素  
      OPENLAYER_MAP.map.getTargetElement().style.cursor = hit?'pointer':''; //设置DOM对象的指针  
  });  

  // //点击事件  
    OPENLAYER_MAP.map.on('click',function(evt){  
        var feature = OPENLAYER_MAP.map.forEachFeatureAtPixel(evt.pixel,function(feature,layer){ //获取鼠标点上的要素  
            return feature;  
            }  
        );  

        if(feature == null)return;

        var coordinate = evt.coordinate;
          var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
          coordinate, 'EPSG:3857', 'EPSG:4326'));

          OPENLAYER_MAP.popContent.innerHTML = '<p>You clicked here:</p><code>' + hdms + '&nbsp;<p1>  feature name : ' + feature.get('name') + '</p1>'
          '</code>';
          OPENLAYER_MAP.popUpItem.setPosition(coordinate);
        
    }  
   );
};

$(function(){
  OPENLAYER_MAP.initAnchorLayer();
  OPENLAYER_MAP.initQQLayer();
  OPENLAYER_MAP.initGoogleLayer();
	OPENLAYER_MAP.initMap();
  // OPENLAYER_MAP.initMapEvents();
  OPENLAYER_MAP.initPopUpEvents();
});

$(document).ready(function(){
     OPENLAYER_MAP.buildRobotRoutePoint();
    OPENLAYER_MAP.updateRobotPosition();
    setInterval('OPENLAYER_MAP.updateRobotPosition()',1000); //指定2秒刷新一次

    OPENLAYER_MAP.initMarkers();
})